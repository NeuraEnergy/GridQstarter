name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate example bundles
        run: |
          python scripts/generate_example_bundles.py

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

      - name: Run backtest on example bundle
        run: |
          gridq backtest examples/bundles/pv_battery_tou

      - name: Check solve time
        run: |
          python -c "
          import json
          with open('examples/bundles/pv_battery_tou/solve_stats.json') as f:
              stats = json.load(f)
          solve_time = stats['solve_time_seconds']
          assert solve_time < 10.0, f'Solve took too long: {solve_time}s'
          print(f'âœ“ Solve time: {solve_time:.2f}s (within limit)')
          "

  docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t gridq-engine:ci .

      - name: Test Docker image
        run: |
          docker run --rm gridq-engine:ci gridq version
